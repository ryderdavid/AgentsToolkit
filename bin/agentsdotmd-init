#!/bin/bash
# agentsdotmd-init - Initialize repository with agents_toolkit
# Usage: agentsdotmd-init [--subdir path]

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

TOOLKIT_DIR="$HOME/.agents_toolkit"
SUBDIR=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --subdir)
            SUBDIR="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Usage: agentsdotmd-init [--subdir path]"
            exit 1
            ;;
    esac
done

# Check if in git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

REPO_ROOT=$(git rev-parse --show-toplevel)
TARGET_DIR="$REPO_ROOT${SUBDIR:+/$SUBDIR}"

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}   Agents Toolkit Initialization${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""
echo -e "${GREEN}Target: $TARGET_DIR${NC}"
echo ""

# 1. Symlink AGENTS.md
echo -e "${YELLOW}[1/7] Symlinking AGENTS.md...${NC}"
if [ -f "$TARGET_DIR/AGENTS.md" ] && [ ! -L "$TARGET_DIR/AGENTS.md" ]; then
    echo -e "${YELLOW}⚠️  AGENTS.md exists (not a symlink)${NC}"
    read -p "Overwrite with symlink? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm "$TARGET_DIR/AGENTS.md"
        ln -s "$TOOLKIT_DIR/AGENTS.md" "$TARGET_DIR/AGENTS.md"
        echo -e "${GREEN}✓ Created symlink${NC}"
    else
        echo -e "${YELLOW}⊘ Skipped${NC}"
    fi
elif [ ! -e "$TARGET_DIR/AGENTS.md" ]; then
    ln -s "$TOOLKIT_DIR/AGENTS.md" "$TARGET_DIR/AGENTS.md"
    echo -e "${GREEN}✓ Created AGENTS.md -> ~/.agents_toolkit/AGENTS.md${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 2. Create AGENTS.local.md with examples
echo ""
echo -e "${YELLOW}[2/7] Creating AGENTS.local.md...${NC}"
if [ ! -f "$TARGET_DIR/AGENTS.local.md" ]; then
    cp "$TOOLKIT_DIR/templates/AGENTS.local.md.example" "$TARGET_DIR/AGENTS.local.md"
    echo -e "${GREEN}✓ Created with examples (uncomment to customize)${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 3. Symlink CLAUDE.md for Claude Code compatibility
echo ""
echo -e "${YELLOW}[3/7] Symlinking CLAUDE.md (Claude Code compat)...${NC}"
if [ ! -e "$TARGET_DIR/CLAUDE.md" ]; then
    ln -s AGENTS.md "$TARGET_DIR/CLAUDE.md"
    echo -e "${GREEN}✓ Created CLAUDE.md -> AGENTS.md${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 4. Symlink .cursor/commands/
echo ""
echo -e "${YELLOW}[4/7] Symlinking .cursor/commands/...${NC}"
mkdir -p "$TARGET_DIR/.cursor"
if [ ! -e "$TARGET_DIR/.cursor/commands" ]; then
    ln -s "$TOOLKIT_DIR/scripts" "$TARGET_DIR/.cursor/commands"
    echo -e "${GREEN}✓ Created .cursor/commands/ -> ~/.agents_toolkit/scripts/${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 5. Copy .cursor/rules/
echo ""
echo -e "${YELLOW}[5/7] Installing .cursor/rules/...${NC}"
mkdir -p "$TARGET_DIR/.cursor/rules/agents-workflow"
if [ ! -f "$TARGET_DIR/.cursor/rules/agents-workflow/RULE.md" ]; then
    cp "$TOOLKIT_DIR/cursor-rules/agents-workflow/RULE.md.template" "$TARGET_DIR/.cursor/rules/agents-workflow/RULE.md"
    echo -e "${GREEN}✓ Installed .cursor/rules/agents-workflow/RULE.md${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 6. Create .issue_screenshots/
echo ""
echo -e "${YELLOW}[6/7] Creating .issue_screenshots/...${NC}"
mkdir -p "$TARGET_DIR/.issue_screenshots"
touch "$TARGET_DIR/.issue_screenshots/.gitkeep"
echo -e "${GREEN}✓ Created .issue_screenshots/${NC}"

# 7. GitHub templates (optional)
echo ""
echo -e "${YELLOW}[7/7] Install GitHub templates?${NC}"
read -p "Install .github/ templates? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    mkdir -p "$TARGET_DIR/.github"
    [ ! -f "$TARGET_DIR/.github/ISSUE_TEMPLATE.md" ] && cp "$TOOLKIT_DIR/templates/ISSUE_TEMPLATE.md" "$TARGET_DIR/.github/" && echo -e "${GREEN}✓ ISSUE_TEMPLATE.md${NC}"
    [ ! -f "$TARGET_DIR/.github/PULL_REQUEST_TEMPLATE.md" ] && cp "$TOOLKIT_DIR/templates/PULL_REQUEST_TEMPLATE.md" "$TARGET_DIR/.github/" && echo -e "${GREEN}✓ PULL_REQUEST_TEMPLATE.md${NC}"
else
    echo -e "${YELLOW}⊘ Skipped${NC}"
fi

echo ""
echo -e "${GREEN}================================================${NC}"
echo -e "${GREEN}   Initialization Complete!${NC}"
echo -e "${GREEN}================================================${NC}"
echo ""
echo -e "${BLUE}Files created:${NC}"
echo "  • AGENTS.md (symlink to global constitution)"
echo "  • AGENTS.local.md (repo-specific overrides)"
echo "  • CLAUDE.md (symlink for Claude Code)"
echo "  • .cursor/commands/ (symlink to scripts)"
echo "  • .cursor/rules/agents-workflow/RULE.md"
echo "  • .issue_screenshots/"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "  1. Review AGENTS.local.md and uncomment customizations"
echo "  2. Commit files: git add AGENTS.md CLAUDE.md .cursor/ .issue_screenshots/"
echo "  3. Open Cursor - rules will auto-load"
echo "  4. Try: .cursor/commands/status.sh"
echo ""
echo -e "${YELLOW}Note: Symlinks are committed to git for team visibility${NC}"
echo ""
