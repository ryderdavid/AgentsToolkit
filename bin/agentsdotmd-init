#!/bin/bash
# agentsdotmd-init - Initialize repository with agents_toolkit
# Usage: agentsdotmd-init [--subdir path]

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

TOOLKIT_DIR="$HOME/.agents_toolkit"
SUBDIR=""
UPDATE_MODE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --subdir)
            SUBDIR="$2"
            shift 2
            ;;
        --update)
            UPDATE_MODE=true
            shift
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Usage: agentsdotmd-init [--subdir path] [--update]"
            exit 1
            ;;
    esac
done

# Check if in git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

REPO_ROOT=$(git rev-parse --show-toplevel)
TARGET_DIR="$REPO_ROOT${SUBDIR:+/$SUBDIR}"

echo -e "${BLUE}================================================${NC}"
if [ "$UPDATE_MODE" = true ]; then
    echo -e "${BLUE}   Agents Toolkit Update Mode${NC}"
else
    echo -e "${BLUE}   Agents Toolkit Initialization${NC}"
fi
echo -e "${BLUE}================================================${NC}"
echo ""
echo -e "${GREEN}Target: $TARGET_DIR${NC}"
echo ""

# 1. Symlink AGENTS.md
echo -e "${YELLOW}[1/9] Symlinking AGENTS.md...${NC}"
if [ -f "$TARGET_DIR/AGENTS.md" ] && [ ! -L "$TARGET_DIR/AGENTS.md" ]; then
    echo -e "${YELLOW}⚠️  AGENTS.md exists (not a symlink)${NC}"
    read -p "Overwrite with symlink? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm "$TARGET_DIR/AGENTS.md"
        ln -s "$TOOLKIT_DIR/AGENTS.md" "$TARGET_DIR/AGENTS.md"
        echo -e "${GREEN}✓ Created symlink${NC}"
    else
        echo -e "${YELLOW}⊘ Skipped${NC}"
    fi
elif [ ! -e "$TARGET_DIR/AGENTS.md" ]; then
    ln -s "$TOOLKIT_DIR/AGENTS.md" "$TARGET_DIR/AGENTS.md"
    echo -e "${GREEN}✓ Created AGENTS.md -> ~/.agents_toolkit/AGENTS.md${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 2. Create AGENTS.local.md with examples
echo ""
echo -e "${YELLOW}[2/9] Creating AGENTS.local.md...${NC}"
if [ "$UPDATE_MODE" = true ]; then
    echo -e "${YELLOW}⊘ Skipped (preserving existing AGENTS.local.md)${NC}"
elif [ ! -f "$TARGET_DIR/AGENTS.local.md" ]; then
    cp "$TOOLKIT_DIR/templates/AGENTS.local.md.example" "$TARGET_DIR/AGENTS.local.md"
    echo -e "${GREEN}✓ Created with examples (uncomment to customize)${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 3. Symlink CLAUDE.md for Claude Code compatibility
echo ""
echo -e "${YELLOW}[3/9] Symlinking CLAUDE.md (Claude Code compat)...${NC}"
if [ ! -e "$TARGET_DIR/CLAUDE.md" ]; then
    ln -s AGENTS.md "$TARGET_DIR/CLAUDE.md"
    echo -e "${GREEN}✓ Created CLAUDE.md -> AGENTS.md${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 4. Symlink .agents/commands/ (agent-agnostic scripts)
echo ""
echo -e "${YELLOW}[4/9] Symlinking .agents/commands/...${NC}"
mkdir -p "$TARGET_DIR/.agents"
if [ ! -e "$TARGET_DIR/.agents/commands" ]; then
    ln -s "$TOOLKIT_DIR/scripts" "$TARGET_DIR/.agents/commands"
    echo -e "${GREEN}✓ Created .agents/commands/ -> ~/.agents_toolkit/scripts/${NC}"
else
    echo -e "${GREEN}✓ Already exists${NC}"
fi

# 4a. Install Cursor markdown command wrappers
echo ""
echo -e "${YELLOW}[5/9] Installing Cursor command wrappers...${NC}"
mkdir -p "$TARGET_DIR/.cursor/commands"
COMMANDS_SRC="$TOOLKIT_DIR/templates/cursor-commands"
COMMANDS_DST="$TARGET_DIR/.cursor/commands"
if [ "$UPDATE_MODE" = true ]; then
    if ls "$COMMANDS_DST"/*.md >/dev/null 2>&1; then
        read -p "Update existing .cursor/commands/*.md from templates? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            for f in "$COMMANDS_SRC"/*.md; do
                [ -f "$f" ] || continue
                cp "$f" "$COMMANDS_DST/"
            done
            echo -e "${GREEN}✓ Updated Cursor command wrappers${NC}"
        else
            echo -e "${YELLOW}⊘ Skipped updating Cursor command wrappers${NC}"
        fi
    else
        for f in "$COMMANDS_SRC"/*.md; do
            [ -f "$f" ] || continue
            cp "$f" "$COMMANDS_DST/"
        done
        echo -e "${GREEN}✓ Installed Cursor command wrappers${NC}"
    fi
else
    INSTALLED_ANY=false
    for f in "$COMMANDS_SRC"/*.md; do
        [ -f "$f" ] || continue
        base="$(basename "$f")"
        if [ ! -f "$COMMANDS_DST/$base" ]; then
            cp "$f" "$COMMANDS_DST/"
            INSTALLED_ANY=true
            echo -e "${GREEN}✓ $base${NC}"
        fi
    done
    if [ "$INSTALLED_ANY" = false ]; then
        echo -e "${GREEN}✓ Cursor command wrappers already present${NC}"
    fi
fi

# 6. Copy .cursor/rules/
echo ""
echo -e "${YELLOW}[6/9] Installing .cursor/rules/...${NC}"
mkdir -p "$TARGET_DIR/.cursor/rules/agents-workflow"
RULE_FILE="$TARGET_DIR/.cursor/rules/agents-workflow/RULE.md"
if [ -f "$RULE_FILE" ]; then
    if [ "$UPDATE_MODE" = true ]; then
        read -p "Update existing RULE.md from template? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm "$RULE_FILE"
            cp "$TOOLKIT_DIR/cursor-rules/agents-workflow/RULE.md.template" "$RULE_FILE"
            echo -e "${GREEN}✓ Updated .cursor/rules/agents-workflow/RULE.md${NC}"
        else
            echo -e "${YELLOW}⊘ Skipped update${NC}"
        fi
    else
        echo -e "${GREEN}✓ Already exists${NC}"
    fi
else
    cp "$TOOLKIT_DIR/cursor-rules/agents-workflow/RULE.md.template" "$RULE_FILE"
    echo -e "${GREEN}✓ Installed .cursor/rules/agents-workflow/RULE.md${NC}"
fi

# 7. Create .issue_screenshots/
echo ""
echo -e "${YELLOW}[7/9] Creating .issue_screenshots/...${NC}"
mkdir -p "$TARGET_DIR/.issue_screenshots"
touch "$TARGET_DIR/.issue_screenshots/.gitkeep"
echo -e "${GREEN}✓ Created .issue_screenshots/${NC}"

# 8. GitHub templates (optional)
echo ""
echo -e "${YELLOW}[8/9] GitHub templates${NC}"
if [ "$UPDATE_MODE" = true ]; then
    UPDATED_ANY=false
    if [ -f "$TARGET_DIR/.github/ISSUE_TEMPLATE.md" ]; then
        read -p "Update existing ISSUE_TEMPLATE.md? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            cp "$TOOLKIT_DIR/templates/ISSUE_TEMPLATE.md" "$TARGET_DIR/.github/ISSUE_TEMPLATE.md"
            echo -e "${GREEN}✓ Updated ISSUE_TEMPLATE.md${NC}"
            UPDATED_ANY=true
        else
            echo -e "${YELLOW}⊘ Skipped ISSUE_TEMPLATE.md${NC}"
        fi
    fi
    if [ -f "$TARGET_DIR/.github/PULL_REQUEST_TEMPLATE.md" ]; then
        read -p "Update existing PULL_REQUEST_TEMPLATE.md? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            cp "$TOOLKIT_DIR/templates/PULL_REQUEST_TEMPLATE.md" "$TARGET_DIR/.github/PULL_REQUEST_TEMPLATE.md"
            echo -e "${GREEN}✓ Updated PULL_REQUEST_TEMPLATE.md${NC}"
            UPDATED_ANY=true
        else
            echo -e "${YELLOW}⊘ Skipped PULL_REQUEST_TEMPLATE.md${NC}"
        fi
    fi
    if [ "$UPDATED_ANY" = false ]; then
        echo -e "${YELLOW}⊘ No existing templates to update${NC}"
    fi
else
    echo -e "${YELLOW}Install .github/ templates?${NC}"
    read -p "Install .github/ templates? (Y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        mkdir -p "$TARGET_DIR/.github"
        [ ! -f "$TARGET_DIR/.github/ISSUE_TEMPLATE.md" ] && cp "$TOOLKIT_DIR/templates/ISSUE_TEMPLATE.md" "$TARGET_DIR/.github/" && echo -e "${GREEN}✓ ISSUE_TEMPLATE.md${NC}"
        [ ! -f "$TARGET_DIR/.github/PULL_REQUEST_TEMPLATE.md" ] && cp "$TOOLKIT_DIR/templates/PULL_REQUEST_TEMPLATE.md" "$TARGET_DIR/.github/" && echo -e "${GREEN}✓ PULL_REQUEST_TEMPLATE.md${NC}"
    else
        echo -e "${YELLOW}⊘ Skipped${NC}"
    fi
fi

# 9. VS Code tasks (optional)
echo ""
echo -e "${YELLOW}[9/9] VS Code tasks${NC}"
TASKS_FILE="$TARGET_DIR/.vscode/tasks.json"
if [ "$UPDATE_MODE" = true ]; then
    if [ -f "$TASKS_FILE" ]; then
        read -p "Update existing .vscode/tasks.json? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            mkdir -p "$TARGET_DIR/.vscode"
            cp "$TOOLKIT_DIR/templates/vscode-tasks.json" "$TASKS_FILE"
            echo -e "${GREEN}✓ Updated .vscode/tasks.json${NC}"
        else
            echo -e "${YELLOW}⊘ Skipped .vscode/tasks.json${NC}"
        fi
    else
        echo -e "${YELLOW}⊘ No existing .vscode/tasks.json to update${NC}"
    fi
else
    echo -e "${YELLOW}Install VS Code tasks?${NC}"
    read -p "Install .vscode/tasks.json? (Y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        mkdir -p "$TARGET_DIR/.vscode"
        if [ ! -f "$TASKS_FILE" ]; then
            cp "$TOOLKIT_DIR/templates/vscode-tasks.json" "$TASKS_FILE"
            echo -e "${GREEN}✓ .vscode/tasks.json${NC}"
        else
            echo -e "${GREEN}✓ .vscode/tasks.json already exists${NC}"
        fi
    else
        echo -e "${YELLOW}⊘ Skipped${NC}"
    fi
fi
echo ""
echo -e "${GREEN}================================================${NC}"
if [ "$UPDATE_MODE" = true ]; then
    echo -e "${GREEN}   Update Complete!${NC}"
else
    echo -e "${GREEN}   Initialization Complete!${NC}"
fi
echo -e "${GREEN}================================================${NC}"
echo ""
echo -e "${BLUE}Files managed:${NC}"
echo "  • AGENTS.md (symlink to global constitution; auto-updates via toolkit)"
echo "  • CLAUDE.md (symlink for Claude Code)"
echo "  • .agents/commands/ (symlink to toolkit scripts; agent-agnostic)"
echo "  • .cursor/commands/*.md (Cursor prompt wrappers for slash commands)"
echo "  • .cursor/rules/agents-workflow/RULE.md (copied; refreshed via --update)"
echo "  • AGENTS.local.md (repo overrides; left untouched in --update)"
echo "  • .issue_screenshots/"
if [ "$UPDATE_MODE" = true ]; then
    echo "  • .github templates (updated only when already present)"
    echo "  • .vscode/tasks.json (updated only when already present)"
else
    echo "  • .github templates (optional install)"
    echo "  • .vscode/tasks.json (optional install)"
fi
echo ""
echo -e "${BLUE}Next steps:${NC}"
if [ "$UPDATE_MODE" = true ]; then
    echo "  1. Review updated files and commit if desired"
    echo "  2. Open Cursor - rules will auto-load"
else
    echo "  1. Review AGENTS.local.md and uncomment customizations"
    echo "  2. Commit files: git add AGENTS.md CLAUDE.md .agents/ .cursor/ .issue_screenshots/"
    echo "  3. Open Cursor - rules will auto-load"
fi
echo "  4. Try: .agents/commands/status.sh (Cursor users can also use /status)"
echo ""
echo -e "${YELLOW}Note: Symlinks are committed to git for team visibility${NC}"
echo ""
