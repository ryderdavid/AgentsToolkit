name: Nightly Release

on:
  schedule:
    # Run at midnight Arizona time (MST, UTC-7) = 07:00 UTC
    - cron: '0 7 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Get latest tag
        id: tag
        run: |
          if git describe --tags --abbrev=0 2>/dev/null; then
            echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
          else
            echo "tag=" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for new commits
        id: changes
        run: |
          if [ -z "${{ steps.tag.outputs.tag }}" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✓ First release - will create nightly"
          else
            COMMIT_COUNT=$(git rev-list ${{ steps.tag.outputs.tag }}..HEAD --count)
            if [ "$COMMIT_COUNT" -eq 0 ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "⚠️  No new commits since ${{ steps.tag.outputs.tag }} - skipping nightly release"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "✓ Found $COMMIT_COUNT new commit(s) since ${{ steps.tag.outputs.tag }}"
            fi
          fi
      
      - name: Generate release notes
        if: steps.changes.outputs.has_changes == 'true'
        id: notes
        run: |
          if [ -z "${{ steps.tag.outputs.tag }}" ]; then
            NOTES="## Nightly Release - ${{ steps.date.outputs.date }}\n\nFirst automated nightly release."
          else
            NOTES="## Nightly Release - ${{ steps.date.outputs.date }}\n\n### Changes since ${{ steps.tag.outputs.tag }}\n\n\`\`\`\n$(git log ${{ steps.tag.outputs.tag }}..HEAD --oneline --no-decorate)\n\`\`\`"
          fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create Release
        if: steps.changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "nightly-${{ steps.date.outputs.date }}-${{ github.run_number }}"
          name: "Nightly Release ${{ steps.date.outputs.date }}-${{ github.run_number }}"
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

